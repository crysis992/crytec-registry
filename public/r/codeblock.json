{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "codeblock",
  "title": "CodeBlock",
  "description": "A compound code block component with syntax highlighting, multi-file tabs, copy button, and customizable themes.",
  "dependencies": ["shiki", "lucide-react"],
  "registryDependencies": ["utils"],
  "files": [
    {
      "path": "registry/new-york/ui/custom/codeblock.tsx",
      "content": "'use client';\n\nimport { Check, ChevronDown, Copy } from 'lucide-react';\nimport * as React from 'react';\nimport type { BundledLanguage, BundledTheme, ShikiTransformer } from 'shiki';\n\nimport { cn } from '@/lib/utils';\n\n/* -----------------------------------------------------------------------------\n * Types\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockData {\n  value: string;\n  filename?: string;\n  code: string;\n  language?: string;\n}\n\ninterface CodeBlockTheme {\n  light: BundledTheme;\n  dark: BundledTheme;\n}\n\ninterface CodeBlockContextValue {\n  items: CodeBlockData[];\n  activeValue: string;\n  setActiveValue: (value: string) => void;\n  highlightedCode: Map<string, string>;\n  isLoading: boolean;\n  showLineNumbers: boolean;\n  theme: CodeBlockTheme;\n  copyCode: () => Promise<void>;\n  hasCopied: boolean;\n}\n\n/* -----------------------------------------------------------------------------\n * Context\n * -------------------------------------------------------------------------- */\n\nconst CodeBlockContext = React.createContext<CodeBlockContextValue | null>(null);\n\nfunction useCodeBlock() {\n  const context = React.useContext(CodeBlockContext);\n  if (!context) {\n    throw new Error('useCodeBlock must be used within a CodeBlock');\n  }\n  return context;\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlock (Root)\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockProps {\n  data: CodeBlockData[];\n  defaultValue?: string;\n  children: React.ReactNode;\n  className?: string;\n  showLineNumbers?: boolean;\n  theme?: CodeBlockTheme;\n}\n\nfunction CodeBlock({\n  data,\n  defaultValue,\n  children,\n  className,\n  showLineNumbers = false,\n  theme = { light: 'github-light', dark: 'github-dark' },\n}: CodeBlockProps) {\n  const [activeValue, setActiveValue] = React.useState(defaultValue ?? data[0]?.value ?? '');\n  const [highlightedCode, setHighlightedCode] = React.useState<Map<string, string>>(new Map());\n  const [isLoading, setIsLoading] = React.useState(false);\n  const [hasCopied, setHasCopied] = React.useState(false);\n\n  // Keep activeValue valid when data changes\n  React.useEffect(() => {\n    if (!activeValue) {\n      setActiveValue(defaultValue ?? data[0]?.value ?? '');\n      return;\n    }\n    const stillExists = data.some((d) => d.value === activeValue);\n    if (!stillExists) {\n      setActiveValue(defaultValue ?? data[0]?.value ?? '');\n    }\n  }, [activeValue, data, defaultValue]);\n\n  const highlightItem = React.useCallback(\n    async (item: CodeBlockData): Promise<string> => {\n      const { codeToHtml } = await import('shiki');\n\n      const code = item.code.trim();\n      const lang = (item.language ?? item.value) as BundledLanguage;\n\n      const transformers: ShikiTransformer[] = [\n        {\n          line(node, line) {\n            if (showLineNumbers) {\n              // Shiki's hast nodes expose `properties`\n              (node as unknown as { properties: Record<string, unknown> }).properties['data-line'] = line;\n            }\n          },\n        },\n      ];\n\n      const baseOptions = {\n        themes: { light: theme.light, dark: theme.dark },\n        transformers,\n      };\n\n      try {\n        return await codeToHtml(code, {\n          lang,\n          ...baseOptions,\n        });\n      } catch {\n        return await codeToHtml(code, {\n          lang: 'plaintext' as BundledLanguage,\n          ...baseOptions,\n        });\n      }\n    },\n    [showLineNumbers, theme.dark, theme.light],\n  );\n\n  // Clear cache when data/theme changes, then highlight active item first.\n  React.useEffect(() => {\n    let cancelled = false;\n\n    setHighlightedCode(new Map());\n\n    const activeItem = data.find((d) => d.value === activeValue) ?? data[0];\n    if (!activeItem) return;\n\n    setIsLoading(true);\n\n    (async () => {\n      try {\n        const html = await highlightItem(activeItem);\n        if (cancelled) return;\n        setHighlightedCode(new Map([[activeItem.value, html]]));\n      } finally {\n        if (!cancelled) setIsLoading(false);\n      }\n    })();\n\n    return () => {\n      cancelled = true;\n    };\n  }, [activeValue, data, highlightItem]);\n\n  // Lazy-highlight other items in idle time after the active item is ready.\n  React.useEffect(() => {\n    if (isLoading) return;\n    if (data.length <= 1) return;\n    if (!highlightedCode.get(activeValue)) return;\n\n    let cancelled = false;\n    const remaining = data.filter((d) => !highlightedCode.has(d.value));\n    if (remaining.length === 0) return;\n\n    const run = () => {\n      (async () => {\n        const next = new Map(highlightedCode);\n        for (const item of remaining) {\n          if (cancelled) return;\n          try {\n            const html = await highlightItem(item);\n            next.set(item.value, html);\n          } catch {\n            // ignore individual failures; active item already rendered\n          }\n        }\n        if (!cancelled) setHighlightedCode(next);\n      })();\n    };\n\n    // Prefer requestIdleCallback, fallback to setTimeout\n    const ric = (globalThis as unknown as { requestIdleCallback?: (cb: () => void) => number }).requestIdleCallback;\n    const cancelRic = (globalThis as unknown as { cancelIdleCallback?: (id: number) => void }).cancelIdleCallback;\n\n    const id = ric ? ric(run) : window.setTimeout(run, 50);\n\n    return () => {\n      cancelled = true;\n      if (ric && cancelRic) cancelRic(id);\n      if (!ric) window.clearTimeout(id);\n    };\n  }, [activeValue, data, highlightedCode, highlightItem, isLoading]);\n\n  React.useEffect(() => {\n    if (hasCopied) {\n      const timeout = setTimeout(() => setHasCopied(false), 2000);\n      return () => clearTimeout(timeout);\n    }\n  }, [hasCopied]);\n\n  const copyCode = React.useCallback(async () => {\n    const activeItem = data.find((item) => item.value === activeValue);\n    if (activeItem) {\n      const text = activeItem.code.trim();\n      if (navigator.clipboard?.writeText) {\n        await navigator.clipboard.writeText(text);\n      } else {\n        // Fallback for environments without Clipboard API\n        const textarea = document.createElement('textarea');\n        textarea.value = text;\n        textarea.style.position = 'fixed';\n        textarea.style.left = '-9999px';\n        textarea.style.top = '-9999px';\n        document.body.appendChild(textarea);\n        textarea.focus();\n        textarea.select();\n        document.execCommand('copy');\n        document.body.removeChild(textarea);\n      }\n      setHasCopied(true);\n    }\n  }, [data, activeValue]);\n\n  const contextValue = React.useMemo(\n    () => ({\n      items: data,\n      activeValue,\n      setActiveValue,\n      highlightedCode,\n      isLoading,\n      showLineNumbers,\n      theme,\n      copyCode,\n      hasCopied,\n    }),\n    [data, activeValue, highlightedCode, isLoading, showLineNumbers, theme, copyCode, hasCopied],\n  );\n\n  return (\n    <CodeBlockContext.Provider value={contextValue}>\n      <div\n        data-slot=\"codeblock\"\n        className={cn('rounded-lg border bg-[var(--muted)] overflow-hidden', className)}\n      >\n        {children}\n      </div>\n    </CodeBlockContext.Provider>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockHeader\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockHeaderProps extends React.ComponentProps<'div'> {}\n\nfunction CodeBlockHeader({ className, children, ...props }: CodeBlockHeaderProps) {\n  return (\n    <div\n      data-slot=\"codeblock-header\"\n      className={cn('flex items-center justify-between border-b px-4 py-2', className)}\n      {...props}\n    >\n      {children}\n    </div>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockFiles\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockFilesProps {\n  children: (item: CodeBlockData) => React.ReactNode;\n  className?: string;\n}\n\nfunction CodeBlockFiles({ children, className }: CodeBlockFilesProps) {\n  const { items } = useCodeBlock();\n\n  return (\n    <div\n      data-slot=\"codeblock-files\"\n      className={cn('flex items-center gap-1', className)}\n    >\n      {items.map((item) => children(item))}\n    </div>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockFilename\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockFilenameProps extends React.ComponentProps<'button'> {\n  value: string;\n}\n\nfunction CodeBlockFilename({ value, children, className, ...props }: CodeBlockFilenameProps) {\n  const { activeValue, setActiveValue } = useCodeBlock();\n  const isActive = activeValue === value;\n\n  return (\n    <button\n      type=\"button\"\n      data-slot=\"codeblock-filename\"\n      data-active={isActive}\n      className={cn(\n        'px-3 py-1 text-sm font-mono rounded-md transition-colors',\n        isActive ? 'bg-[var(--background)] text-[var(--foreground)]' : 'text-[var(--muted-foreground)] hover:text-[var(--foreground)]',\n        className,\n      )}\n      onClick={() => setActiveValue(value)}\n      {...props}\n    >\n      {children}\n    </button>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockSelect\n * -------------------------------------------------------------------------- */\n\nconst CodeBlockSelectContext = React.createContext<{\n  open: boolean;\n  setOpen: React.Dispatch<React.SetStateAction<boolean>>;\n} | null>(null);\n\ninterface CodeBlockSelectProps {\n  children: React.ReactNode;\n}\n\nfunction CodeBlockSelect({ children }: CodeBlockSelectProps) {\n  const [open, setOpen] = React.useState(false);\n\n  return (\n    <CodeBlockSelectContext.Provider value={{ open, setOpen }}>\n      <div\n        data-slot=\"codeblock-select\"\n        className=\"relative\"\n      >\n        {children}\n      </div>\n    </CodeBlockSelectContext.Provider>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockSelectTrigger\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockSelectTriggerProps extends React.ComponentProps<'button'> {}\n\nfunction CodeBlockSelectTrigger({ className, children, ...props }: CodeBlockSelectTriggerProps) {\n  const selectContext = React.useContext(CodeBlockSelectContext);\n\n  return (\n    <button\n      type=\"button\"\n      data-slot=\"codeblock-select-trigger\"\n      className={cn(\n        'flex items-center gap-2 px-3 py-1 text-sm font-mono rounded-md border bg-[var(--background)] transition-colors hover:bg-[var(--accent)]',\n        className,\n      )}\n      onClick={() => selectContext?.setOpen((prev) => !prev)}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4\" />\n    </button>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockSelectValue\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockSelectValueProps {\n  placeholder?: string;\n}\n\nfunction CodeBlockSelectValue({ placeholder }: CodeBlockSelectValueProps) {\n  const { items, activeValue } = useCodeBlock();\n  const activeItem = items.find((item) => item.value === activeValue);\n\n  return <span data-slot=\"codeblock-select-value\">{activeItem?.filename ?? activeItem?.value ?? placeholder ?? 'Select...'}</span>;\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockSelectContent\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockSelectContentProps {\n  children: (item: CodeBlockData) => React.ReactNode;\n}\n\nfunction CodeBlockSelectContent({ children }: CodeBlockSelectContentProps) {\n  const selectContext = React.useContext(CodeBlockSelectContext);\n  const { items } = useCodeBlock();\n\n  if (!selectContext?.open) return null;\n\n  return (\n    <div\n      data-slot=\"codeblock-select-content\"\n      className=\"absolute top-full left-0 mt-1 min-w-[150px] rounded-md border bg-[var(--background)] shadow-md z-50\"\n    >\n      {items.map((item) => children(item))}\n    </div>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockSelectItem\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockSelectItemProps extends React.ComponentProps<'button'> {\n  value: string;\n}\n\nfunction CodeBlockSelectItem({ value, children, className, ...props }: CodeBlockSelectItemProps) {\n  const { activeValue, setActiveValue } = useCodeBlock();\n  const selectContext = React.useContext(CodeBlockSelectContext);\n  const isActive = activeValue === value;\n\n  return (\n    <button\n      type=\"button\"\n      data-slot=\"codeblock-select-item\"\n      data-active={isActive}\n      className={cn(\n        'w-full px-3 py-2 text-sm text-left transition-colors hover:bg-[var(--accent)]',\n        isActive && 'bg-[var(--accent)]',\n        className,\n      )}\n      onClick={() => {\n        setActiveValue(value);\n        selectContext?.setOpen(false);\n      }}\n      {...props}\n    >\n      {children}\n    </button>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockCopyButton\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockCopyButtonProps extends React.ComponentProps<'button'> {\n  onCopy?: () => void;\n  onError?: (error: unknown) => void;\n}\n\nfunction CodeBlockCopyButton({ onCopy, onError, className, ...props }: CodeBlockCopyButtonProps) {\n  const { copyCode, hasCopied } = useCodeBlock();\n\n  const handleCopy = async () => {\n    try {\n      await copyCode();\n      onCopy?.();\n    } catch (error) {\n      onError?.(error);\n    }\n  };\n\n  return (\n    <button\n      type=\"button\"\n      data-slot=\"codeblock-copy\"\n      className={cn(\n        'h-8 w-8 inline-flex items-center justify-center rounded-md border bg-[var(--background)] transition-all hover:bg-[var(--accent)] focus:outline-none',\n        className,\n      )}\n      onClick={handleCopy}\n      aria-label=\"Copy code\"\n      {...props}\n    >\n      {hasCopied ? <Check className=\"h-4 w-4 text-green-500\" /> : <Copy className=\"h-4 w-4\" />}\n    </button>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockBody\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockBodyProps {\n  children: (item: CodeBlockData) => React.ReactNode;\n  className?: string;\n}\n\nfunction CodeBlockBody({ children, className }: CodeBlockBodyProps) {\n  const { items } = useCodeBlock();\n\n  return (\n    <div\n      data-slot=\"codeblock-body\"\n      className={className}\n    >\n      {items.map((item) => children(item))}\n    </div>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockItem\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockItemProps extends React.ComponentProps<'div'> {\n  value: string;\n}\n\nfunction CodeBlockItem({ value, children, className, ...props }: CodeBlockItemProps) {\n  const { activeValue } = useCodeBlock();\n\n  if (activeValue !== value) return null;\n\n  return (\n    <div\n      data-slot=\"codeblock-item\"\n      className={cn('relative', className)}\n      {...props}\n    >\n      {children}\n    </div>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockContent\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockContentProps extends React.ComponentProps<'div'> {\n  showLineNumbers?: boolean;\n}\n\nfunction CodeBlockContent({ showLineNumbers: propShowLineNumbers, className, ...props }: CodeBlockContentProps) {\n  const { highlightedCode, isLoading, showLineNumbers: contextShowLineNumbers, activeValue } = useCodeBlock();\n\n  const showLines = propShowLineNumbers ?? contextShowLineNumbers;\n  const html = highlightedCode.get(activeValue) ?? '';\n\n  if (isLoading) {\n    return (\n      <div\n        data-slot=\"codeblock-content\"\n        className={cn('p-4 text-sm text-[var(--muted-foreground)]', className)}\n      >\n        <div className=\"animate-pulse\">Loading...</div>\n      </div>\n    );\n  }\n\n  return (\n    <div\n      data-slot=\"codeblock-content\"\n      className={cn(\n        'overflow-x-auto text-sm p-4',\n        showLines && 'codeblock-line-numbers',\n        '[&_pre]:!bg-transparent [&_pre]:!p-0 [&_code]:!bg-transparent',\n        className,\n      )}\n      dangerouslySetInnerHTML={{ __html: html }}\n      {...props}\n    />\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * CodeBlockFooter\n * -------------------------------------------------------------------------- */\n\ninterface CodeBlockFooterProps extends React.ComponentProps<'div'> {}\n\nfunction CodeBlockFooter({ className, children, ...props }: CodeBlockFooterProps) {\n  return (\n    <div\n      data-slot=\"codeblock-footer\"\n      className={cn('border-t px-4 py-2 text-sm text-[var(--muted-foreground)]', className)}\n      {...props}\n    >\n      {children}\n    </div>\n  );\n}\n\n/* -----------------------------------------------------------------------------\n * Exports\n * -------------------------------------------------------------------------- */\n\nexport {\n  // Compound components\n  CodeBlock,\n  CodeBlockBody,\n  CodeBlockContent,\n  CodeBlockCopyButton,\n  CodeBlockFilename,\n  CodeBlockFiles,\n  CodeBlockFooter,\n  CodeBlockHeader,\n  CodeBlockItem,\n  CodeBlockSelect,\n  CodeBlockSelectContent,\n  CodeBlockSelectItem,\n  CodeBlockSelectTrigger,\n  CodeBlockSelectValue,\n  // Types\n  type CodeBlockData,\n  type CodeBlockTheme,\n};\n",
      "type": "registry:ui"
    }
  ],
  "type": "registry:ui"
}
